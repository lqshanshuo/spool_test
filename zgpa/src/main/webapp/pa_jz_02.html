<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="The Matrix Components Framework">
  <meta name="author" content="LY">
  <title>中国平安</title>
  <link rel="shortcut icon" href="assets/self-owned/ico/favicon.png">
  <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="assets/reference/flat-ui/css/flat-ui.css">
  <link rel="stylesheet" type="text/css" href="assets/reference/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="assets/self-owned/css/matrix.css">
  <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap-fileinput/css/fileinput_ly.css" media="all">


  <style>
    .row > [class*="col-"] {
      margin-bottom: 0px;
    }
  </style>
</head>

<body>

  <div id="contentDiv" class="flat-matrix" style="background-image: url(assets/self-owned/img/zgpa/jz_background.jpg);background-repeat: no-repeat;background-size:100% 100%;margin-top:0px;min-height:688px;">
    <div class="container-fluid">
      <div style="margin-top:300px">
        <div class="row">
          <div class="col-xs-6">
            <div id="matrix_upload_div">
              <div class="row">
                <div data-bind="foreach:uploadedFileUrls">
                  <div class="col-xs-12 text-center" style="margin-bottom:10px">
                    <img data-bind="attr:{src:$data}" class="img-thumbnail" style="width:180px;height:180px">
                  </div>
                </div>
              </div>
              <br>
              <div class="row" id="upload_div_1">
                <div class="col-xs-12" style="margin-top: -25px;">
                  <form class="form-horizontal">
                    <div class="form-group">
                      <div class="col-xs-12">
                        <input id="input-id-1" type="file" name="file">
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>


          <div class="col-xs-6">
            <div id="matrix_upload_div_2">
              <div class="row">
                <div data-bind="foreach:uploadedFileUrls">
                  <div class="col-xs-12 text-center" style="margin-bottom:10px">
                    <img data-bind="attr:{src:$data}" class="img-thumbnail" style="width:180px;height:180px">
                  </div>
                </div>
              </div>
              <br>
              <div class="row" id="upload_div_2">
                <div class="col-xs-12" style="margin-top: -25px;">
                  <form class="form-horizontal">
                    <div class="form-group">
                      <div class="col-xs-12">
                        <input id="input-id-2" type="file" name="file">
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info alert-dismissible fresh-color" role="alert" style="margin-top: 16px;font-size:11px">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <strong><i class="fa fa-heart-o fa-1x "></i>&nbsp;友情提示:</strong>
          <br> 1, &nbsp;单张上传图片最大限制为2M
          <br> 2, &nbsp;点击右下角图标&nbsp;<i class="fa fa-trash-o fa-1x "></i>&nbsp;可以删除待上传图片
          <br> 3, &nbsp;点击右下角图标&nbsp;<i class="glyphicon glyphicon-upload "></i>&nbsp;进行文件上传操作
        </div>

        <div id="validation_div" style="margin:0px 18px">
          <!--Validation DIV BEGIN-->
          <div data-bind="visible: hasError" class="alert alert-warning alert-dismissible fresh-color" role="alert" style="display:none">
            <button type="button" data-bind="click:function(){hasError(!hasError)}" class="close" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <strong>友情提示:</strong>
            <div id="errorMessagesDIV" data-bind="foreach:errorMessage">
              <div data-bind="text:$data"></div>
            </div>
          </div>
          <!--Validation DIV END-->
        </div>
        <div id="business_content_div">
          <div class="row">
            <div class="col-xs-12 text-center" style="margin-bottom:0px">
              <form class="form-horizontal">
                <div class="form-group">
                  <div class="col-xs-6 col-xs-offset-3 text-center">
                    <select class="form-control select_1 select-primary select-block mbl" style="text-center; margin-bottom: 0;" data-bind="options:items,value:chosenItem,optionsCaption: '请选择...'"></select>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="row">
            <div class="col-xs-12 text-center">
              <form class="form-horizontal">
                <div class="form-group text-center" style="margin-bottom: 6px;">
                  <div class="col-xs-12 text-center" style="overflow: auto">
                    <textarea style="text-align:center;border: 1px solid transparent;border-radius: 8px;background-color:#e27371;color:white;font-size:12px" data-bind="value:inputContent,valueUpdate:'input'" rows="5" cols="36">
                    </textarea>
                  </div>
                </div>
                <div class="form-group ">
                  <div class="col-xs-12 text-center">
                    <a class="btn btn-danger  btn-wide text-center" href="javascript:void(0)" style="height: 32px;padding-top: 3px;font-size:18px;font-weight:bold;border: 1px solid transparent;border-radius: 38px;color:#e74c3c;font-weight:bold;background-color:white" onclick="persist()">请您的亲人朋友共同见证吧 </a>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="assets/reference/jquery/jquery-1.11.1.min.js"></script>
  <script src="assets/reference/jquery/jquery.json.js"></script>
  <script src="assets/reference/knockout.js/knockout-3.3.0.js"></script>
  <script src="assets/reference/jquery-tiny-pubsub/tiny-pubsub.js"></script>
  <script src="assets/reference/flat-ui/js/vendor/video.js"></script>
  <script src="assets/reference/flat-ui/js/flat-ui.min.js"></script>
  <script src="assets/reference/flat-ui/docs/assets/js/prettify.js"></script>
  <script src="assets/reference/flat-ui/docs/assets/js/application.js"></script>
  <script src="assets/reference/bootstrap-fileinput/js/fileinput_ly.js"></script>
  <script src="assets/reference/bootstrap-fileinput/js/locales/zh.js"></script>
  <!-- Javascript for Matrix Self Owned -->
  <script src="assets/self-owned/js/generic/generic_algorithm.js"></script>
  <script src="assets/self-owned/js/generic/generic_cache.js"></script>
  <script src="assets/self-owned/js/generic/generic_charting.js"></script>
  <script src="assets/self-owned/js/generic/generic_csv.js"></script>
  <script src="assets/self-owned/js/generic/generic_cud.js"></script>
  <script src="assets/self-owned/js/generic/generic_modal.js"></script>
  <script src="assets/self-owned/js/generic/generic_prototype.js"></script>
  <script src="assets/self-owned/js/generic/generic_query.js"></script>
  <script src="assets/self-owned/js/generic/generic_table.js"></script>
  <script src="assets/self-owned/js/generic/generic_util.js"></script>
  <script src="assets/self-owned/js/generic/generic_validation.js"></script>
  <script src="assets/self-owned/js/generic/generic_upload.js"></script>

  <script>
    function getUserInfo() {
      var query = {
        "param1": "YINGXIAO_OR_QUTUO"
      };
      var url = $.getRootPath() + "/api/account/getUserInfo";
      var data = {
        'queryJson': JSON.stringify(query)
      }


      $.serverRequest(url, data, "JIANZHENG_GET_USER_INFO_SUCCESS", "JIANZHENG_GET_USER_INFO_RESPONSE_ERROR", "JIANZHENG_GET_USER_INFO_SERVER_ERROR", "POST");

      $.subscribe("JIANZHENG_GET_USER_INFO_SUCCESS", jianzhengGetUserInfoSuccessListener);
      $.subscribe("JIANZHENG_GET_USER_INFO_RESPONSE_ERROR", jianzhengGetUserInfoFailedListener);
      $.subscribe("JIANZHENG_GET_USER_INFO_SERVER_ERROR", jianzhengGetUserInfoFailedListener);

    }

    function jianzhengGetUserInfoSuccessListener() {

      if (arguments && arguments[1]) {
        var resp = arguments[1];
        var userInfo = eval("(" + resp.result[0] + ")");
        business_vm.userInfo(userInfo);
        if (userInfo && userInfo.personal_code) {
          if (vm) {
            vm.key1(userInfo.personal_code);
          }
          if (vm2) {
            vm2.key1(userInfo.personal_code);
          }
        }
      }
    }

    function jianzhengGetUserInfoFailedListener() {
      console.log("get user failed")
      location.href = $.getRootPath() + '/pa_jz_01.html';
    }
  </script>
  <script>
    var vm = new GenericUploadPageViewModel(null, 'zpga', 'jz_module', 'jz_function');
    ko.applyBindings(vm, document.getElementById('matrix_upload_div'));
    $.subscribe("SUCCESS_LISTENER", successListener);
    $.subscribe("FAILED_LISTENER", failedListener);
    initialize_pic_upload_environment('input-id-1', vm);

    function failedListener() {
      if (arguments && arguments[1]) {
        var errorMessage = arguments[1].errorMessage;
        // vm.alerts.errorResponse(errorMessage, "Server Service Error!", "Please read the message below:");
        console.log("Upload error:" + errorMessage);
      }
    }

    function successListener() {
      if (arguments && arguments[1]) {
        var img_url_path = $.getServerRoot() + "/service_generic_query" + arguments[1].result[0].stringkappa;
        if (vm) {
          vm.uploadedFileUrls.push(img_url_path);

          setTimeout(function() {
            // $('#input-id').fileinput('refresh');
            $('#upload_div_1').remove();
          }, 200);
        }
      }
    }
  </script>


  <script>
    var vm2 = new GenericUploadPageViewModel(null, 'zpga', 'jz_module', 'jz_function');
    ko.applyBindings(vm2, document.getElementById('matrix_upload_div_2'));
    $.subscribe("SUCCESS_LISTENER_2", successListener2);
    $.subscribe("FAILED_LISTENER_2", failedListener2);
    initialize_pic_upload_environment('input-id-2', vm2, "SUCCESS_LISTENER_2", "FAILED_LISTENER_2");

    function failedListener2() {
      if (arguments && arguments[1]) {
        var errorMessage = arguments[1].errorMessage;
        // vm.alerts.errorResponse(errorMessage, "Server Service Error!", "Please read the message below:");
        console.log("Upload error:" + errorMessage);
      }
    }

    function successListener2() {
      if (arguments && arguments[1]) {
        var img_url_path = $.getServerRoot() + "/service_generic_query" + arguments[1].result[0].stringkappa;
        if (vm2) {
          vm2.uploadedFileUrls.push(img_url_path);

          setTimeout(function() {
            // $('#input-id').fileinput('refresh');
            $('#upload_div_2').remove();
          }, 200);
        }
      }
    }
  </script>
  <script>
    function BusinessViewModel() {
      var self = this;
      self.items = ko.observableArray(['感恩型', '荣誉型', '分享型']);
      self.chosenItem = ko.observable();
      self.inputContent = ko.observable();
      self.userInfo = ko.observable();
      self.chosenItem.subscribe(function(newValue) {
        // alert(newValue);
        if ("感恩型" === newValue) {
          var txt =
            "你们的支持，给予我一往无前的勇气！\n" +
            "你们的陪伴，让我在路途中不曾孤单！\n" +
            "你们的理解，让我更加坚定前行的脚步！\n" +
            "2016，感恩有你！\n" +
            "2017，我们继续前行！";
          self.inputContent(txt);
        }
        if ("荣誉型" === newValue) {
          var txt =
            "这是我们辛勤付出的见证！\n" +
            "这是我们成功最直观的体现！\n" +
            "这是我们最为宝贵的传承！\n" +
            "2016，荣誉铺筑！\n" +
            "2017，我们继续前行！";
          self.inputContent(txt);
        }
        if ("分享型" === newValue) {
          var txt =
            "困难——一起分担才会让它显得微不足道！\n" +
            "快乐——一起品尝才会让它滋润你的心田！\n" +
            "成功——一起分享才会散发出幸福的滋味！\n" +
            "2016，你我共同分享甜蜜！\n" +
            "2017，我们继续前行！";
          self.inputContent(txt);
        }
      });
    }
    var business_vm = new BusinessViewModel();
    ko.applyBindings(business_vm, document.getElementById('business_content_div'));
    business_vm.chosenItem('感恩型');


    //                                                var vm = new GenericUploadPageViewModel();
    //                                                ko.applyBindings(vm, document.getElementById('matrix_upload_div'));
    //                                                $.subscribe("SUCCESS_LISTENER", successListener);
    //                                                $.subscribe("FAILED_LISTENER", failedListener);
    //                                                initialize_pic_upload_environment('input-id', vm);
    getUserInfo();

    //                                                function failedListener() {
    //                                                    if (arguments && arguments[1]) {
    //                                                        var errorMessage = arguments[1].errorMessage;
    //                                                        vm.alerts.errorResponse(errorMessage, "Server Service Error!", "Please read the message below:");
    //                                                    }
    //                                                }
    //
    //                                                function successListener() {
    //                                                    if (arguments && arguments[1]) {
    //
    //                                                        var img_url_path = $.getServerRoot() + "/service_generic_query" + arguments[1].result[0].stringkappa;
    //                                                        debugger;
    //                                                        if (vm) {
    //                                                            vm.uploadedFileUrls.push(img_url_path);
    //
    //                                                            setTimeout(function () {
    //                                                                $('#input-id').fileinput('refresh');
    //                                                            }, 200);
    //                                                        }
    //                                                    }
    //                                                }

    // *******YOUR SHOULD CODING IN HERE:*******
    var businessValidation = function() {
      var errorMessages = [];
      //validate logic...

      //validate
      ValidationPOJO.validate("见证卡类型", business_vm.chosenItem(), errorMessages, ['KEY_NOT_NULL']);
      ValidationPOJO.validate("您的心愿", business_vm.inputContent(), errorMessages, ['KEY_NOT_NULL', 'KEY_NOT_MAX']);

      if (vm.uploadedFileUrls().length < 1 && vm2.uploadedFileUrls().length < 1) {
        errorMessages.push("您还没有上传图片");
      }
      return errorMessages;
    }

    var genericModalViewModel = new GenericModalViewModel();
    ko.applyBindings(genericModalViewModel, document.getElementById('validation_div'));

    function persist() {
      if (!genericModalViewModel.validation(businessValidation)) {
        return;
      } else {
        // validation correct
        // do your business...
        var json = {
          file_url_list: vm.uploadedFileUrls().concat(vm2.uploadedFileUrls()),
          business_info: {
            info_1: business_vm.chosenItem(),
            info_2: business_vm.inputContent()
          }
        }

        var param = JSON.stringify(json);

        param = UtilPOJO.encode(param);
        var shareJson = {
          'type': 'JianZhengKa',
          'json': param,
          'username': business_vm.userInfo().staff_name,
          'stringalpha': business_vm.userInfo().personal_code
        }
        var data = {
          'shareJson': $.toJSON(shareJson)
        };

        $.serverRequest($.getServerRoot() + '/service_generic_query/api/share/generate/9999', data, "TOKEN_SUCCESS", "TOKEN_FAILED", "TOKEN_SERVICE_FAILED");

      }

    }
    $.subscribe("TOKEN_SUCCESS", tokenSuccessListener);
    $.subscribe("TOKEN_FAILED", tokenFailedListener);
    $.subscribe("TOKEN_SERVICE_FAILED", tokenServiceListener);

    function tokenSuccessListener() {
      if (arguments && arguments[1]) {
        window.location.replace($.getRootPath() + '/pa_jz_03.html?token=' + arguments[1].result[0]);
      }
    }

    function tokenFailedListener() {
      if (arguments && arguments[1]) {
        var errorMessage = arguments[1].errorMessage;
        console.log(errorMessage);
      }
    }

    function tokenServiceListener() {}
  </script>
</body>

</html>
